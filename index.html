# --- Configuration ---
$DownloadUrl = "https://github.com/NetKillX/netkillx.github.io/releases/download/2.0/main.exe"
$FileName    = "main.exe"
# ---------------------

# The entire logic is contained in a self-invoking script block (& { ... }) for clean execution via iex.
& {
    $TempDir = "$env:TEMP"
    $ExePath = Join-Path -Path $TempDir -ChildPath $FileName
    $ExitCode = 0
    
    Write-Host "Local cache path: $ExePath" -ForegroundColor DarkGray
    
    # --- Caching and Download Logic ---
    if (Test-Path $ExePath) {
        Write-Host "âœ… Found cached file: $FileName. Skipping download." -ForegroundColor Green
    }
    else {
        $WebClient = New-Object System.Net.WebClient
        
        Write-Host "Starting download from $DownloadUrl..." -ForegroundColor Cyan

        try {
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 -bor [Net.SecurityProtocolType]::Tls13
            $WebClient.DownloadFile($DownloadUrl, $ExePath)
            Write-Host "Download complete. File saved to: $ExePath" -ForegroundColor Green
        }
        catch {
            Write-Host "An error occurred during download: $($_.Exception.Message)" -ForegroundColor Red
            return
        }
    }

    # --- Execution Logic ---
    if (Test-Path $ExePath) {
        Write-Host "Executing $FileName in the current terminal..." -ForegroundColor Yellow
        
        try {
            # Execute the EXE
            & $ExePath
            $ExitCode = $LASTEXITCODE
            Write-Host "Program execution finished. Exit Code: $ExitCode" -ForegroundColor Green
        }
        catch {
            Write-Host "An error occurred during execution: $($_.Exception.Message)" -ForegroundColor Red
            $ExitCode = 1
        }
    }
    else {
        Write-Host "Cannot execute. The file was not found locally." -ForegroundColor Red
        $ExitCode = 1
    }

    exit $ExitCode
}
