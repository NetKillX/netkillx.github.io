# --- Configuration ---
# Hardcoded download URL and local file name
$DownloadUrl = "https://github.com/NetKillX/netkillx.github.io/releases/download/2.0/main.exe"
$FileName    = "main.exe"
# ---------------------

# --- ASCII Art Banner ---
Write-Host ""
Write-Host "    _   _________  __   ____  ____  ____  ________    ____  ___    ____  __________ " -ForegroundColor Cyan
Write-Host "   / | / /_  __/ |/ /   / __ )/ __ \/ __ \/_  __/ /    / __ \/   |  / __ \/ ____/ __ \ " -ForegroundColor Cyan
Write-Host "  /  |/ / / /  |  </  / __  / / / / / / / / / / /    / / / / /| | / / / / __/ / /_/ / " -ForegroundColor Cyan
Write-Host " / /|  / / /  /  |  / /_/ / /_/ / /_/ / / / / /___/ /_/ / ___ |/ /_/ / /___/ _, _/ " -ForegroundColor Cyan
Write-Host "/_/ |_/ /_/  /_/|_| /_____/\____/\____/ /_/ /_____/\____/_/  |_/_____/_____/_/ |_| " -ForegroundColor Cyan
Write-Host ""
# ------------------------

# The entire logic is wrapped in a self-invoking script block (& { ... }) for clean execution.
& {
    $TempDir = "$env:TEMP"
    # Local path for the cached executable
    $ExePath = Join-Path -Path $TempDir -ChildPath $FileName
    $ExitCode = 0
    
    Write-Host "Local cache path: $ExePath" -ForegroundColor DarkGray
    
    # --- Caching and Download Logic ---
    if (Test-Path $ExePath) {
        Write-Host "âœ… Found cached file: $FileName. Skipping download." -ForegroundColor Green
    }
    else {
        # File not found, proceed with download
        
        Write-Host "Starting download from $DownloadUrl..." -ForegroundColor Cyan

        try {
            # FIX: Correct type name is [Net.SecurityProtocolType]
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 -bor [Net.SecurityProtocolType]::Tls13
            
            # Download the file using Invoke-WebRequest, which supports the progress bar.
            # We pipe the output to Out-Null to suppress the object output but keep the progress bar.
            Invoke-WebRequest -Uri $DownloadUrl -OutFile $ExePath -UseBasicParsing -SkipCertificateCheck | Out-Null
            
            Write-Host "Download complete. File saved to: $ExePath" -ForegroundColor Green
        }
        catch {
            # Write-Host does not show the progress bar from IWR, but it handles errors.
            Write-Host "An error occurred during download: $($_.Exception.Message)" -ForegroundColor Red
            # Exit the script block on download failure
            return 
        }
    }

    # --- Execution Logic ---
    if (Test-Path $ExePath) {
        Write-Host "Executing $FileName in the current terminal..." -ForegroundColor Yellow
        
        try {
            # Use the call operator (&) to execute the file
            & $ExePath
            $ExitCode = $LASTEXITCODE
            Write-Host "Program execution finished. Exit Code: $ExitCode" -ForegroundColor Green
        }
        catch {
            Write-Host "An error occurred during execution: $($_.Exception.Message)" -ForegroundColor Red
            $ExitCode = 1
        }
    }
    else {
        Write-Host "Cannot execute. The file was not found locally." -ForegroundColor Red
        $ExitCode = 1
    }

    # Return the program's exit code to the shell
    exit $ExitCode
}
